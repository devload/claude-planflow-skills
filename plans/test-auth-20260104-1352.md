# Plan: test-auth

**Date**: 2026-01-04 13:52
**Status**: Draft
**Prompt**: "JWT authentication feature"

## Objectives

Implement a complete JWT-based authentication system with:
- User registration and login
- Access token and refresh token flow
- Token validation middleware
- Secure password hashing
- Token refresh mechanism

## Scope

### In Scope
- User registration endpoint with email/password
- User login endpoint returning JWT tokens
- Access token (short-lived) and refresh token (long-lived) pair
- Authentication middleware for protected routes
- Token refresh endpoint
- Logout functionality (token invalidation)
- Password hashing with bcrypt

### Out of Scope
- OAuth/social login integration
- Email verification
- Password reset flow
- Role-based access control (RBAC)
- Multi-factor authentication (MFA)

## Technical Approach

### Architecture
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client    │────▶│  Auth API   │────▶│  Database   │
│             │◀────│  (Express)  │◀────│ (PostgreSQL)│
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                    ┌──────┴──────┐
                    │ JWT Service │
                    └─────────────┘
```

### Key Decisions
1. **JWT with Refresh Tokens**: Access tokens expire in 15 minutes, refresh tokens in 7 days. This balances security with user experience.
2. **bcrypt for Password Hashing**: Industry standard with automatic salt generation.
3. **Refresh Token in Database**: Store refresh tokens to enable revocation and single-device logout.
4. **Express Middleware**: Reusable authentication middleware for route protection.

### Tech Stack
- **Runtime**: Node.js
- **Framework**: Express.js
- **Language**: TypeScript
- **Database**: PostgreSQL with Prisma ORM
- **JWT Library**: jsonwebtoken
- **Password Hashing**: bcrypt
- **Validation**: zod

## Implementation Phases

### Phase 1: Foundation Setup
**Goal**: Set up project structure and database schema

**Tasks**:
- [ ] T-1.1: Initialize project with TypeScript configuration
- [ ] T-1.2: Set up Prisma with PostgreSQL connection
- [ ] T-1.3: Create User and RefreshToken database models
- [ ] T-1.4: Set up Express server with basic middleware

### Phase 2: Core Authentication
**Goal**: Implement registration and login functionality

**Tasks**:
- [ ] T-2.1: Create password hashing utility with bcrypt
- [ ] T-2.2: Implement user registration endpoint
- [ ] T-2.3: Implement JWT token generation service
- [ ] T-2.4: Implement user login endpoint
- [ ] T-2.5: Create input validation schemas with zod

### Phase 3: Token Management
**Goal**: Implement token refresh and authentication middleware

**Tasks**:
- [ ] T-3.1: Implement authentication middleware
- [ ] T-3.2: Implement token refresh endpoint
- [ ] T-3.3: Implement logout endpoint (token revocation)
- [ ] T-3.4: Add protected route example

### Phase 4: Testing & Security
**Goal**: Add tests and security hardening

**Tasks**:
- [ ] T-4.1: Write unit tests for auth services
- [ ] T-4.2: Write integration tests for auth endpoints
- [ ] T-4.3: Add rate limiting to auth endpoints
- [ ] T-4.4: Security review and documentation

## File Changes

### New Files
- `src/index.ts` - Express server entry point
- `src/config/index.ts` - Environment configuration
- `prisma/schema.prisma` - Database schema
- `src/services/auth.service.ts` - Authentication business logic
- `src/services/token.service.ts` - JWT token operations
- `src/services/password.service.ts` - Password hashing
- `src/middleware/auth.middleware.ts` - Route protection
- `src/routes/auth.routes.ts` - Auth endpoints
- `src/validators/auth.validator.ts` - Input validation
- `src/types/index.ts` - TypeScript type definitions
- `tests/auth.test.ts` - Authentication tests

### Modified Files
- `package.json` - Add dependencies

## Dependencies

### External Dependencies
- express: ^4.18.x
- jsonwebtoken: ^9.x
- bcrypt: ^5.x
- prisma: ^5.x
- @prisma/client: ^5.x
- zod: ^3.x
- dotenv: ^16.x

### Dev Dependencies
- typescript: ^5.x
- @types/express: ^4.x
- @types/jsonwebtoken: ^9.x
- @types/bcrypt: ^5.x
- jest: ^29.x
- ts-jest: ^29.x
- supertest: ^6.x

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Token theft | High | Use HTTPS, short access token expiry, secure cookie flags |
| Brute force attacks | Medium | Rate limiting on login/register endpoints |
| Refresh token leak | High | Store in httpOnly cookies, implement token rotation |
| Database breach | High | Hash passwords with bcrypt, never store plain tokens |

## Notes

- Environment variables needed: `DATABASE_URL`, `JWT_SECRET`, `JWT_REFRESH_SECRET`, `ACCESS_TOKEN_EXPIRY`, `REFRESH_TOKEN_EXPIRY`
- Consider implementing token blacklisting for immediate revocation if needed
- For production, use secure cookie settings and HTTPS
