# Plan: user-profile

**Date**: 2026-01-04 14:10
**Status**: Draft
**Prompt**: "User profile management with avatar upload"

## Objectives

Implement a comprehensive user profile management system that allows authenticated users to:
- View and update their profile information
- Upload, update, and delete avatar images
- Manage profile visibility and preferences

## Scope

### In Scope
- Profile CRUD operations (view, update)
- Avatar image upload with validation (file type, size)
- Avatar storage (local filesystem or S3-compatible)
- Image processing (resize, optimize)
- Profile data validation
- Integration with existing auth system (test-auth)

### Out of Scope
- Social login profile import
- Profile sharing/public profiles
- Profile activity history
- Multi-avatar support

## Technical Approach

### Architecture

```
Client Request
     ↓
[Auth Middleware] → Verify JWT token
     ↓
[Profile Routes] → /profile/*
     ↓
[Multer Middleware] → Handle file uploads
     ↓
[Profile Service] → Business logic
     ↓
[Storage Service] → File storage (local/S3)
     ↓
[Prisma] → Database operations
```

### Key Decisions

1. **Multer for File Uploads**: Industry-standard multipart/form-data handling for Express
2. **Sharp for Image Processing**: High-performance image resizing and optimization
3. **Pluggable Storage**: Abstract storage interface supporting local filesystem and S3
4. **UUID Filenames**: Prevent filename collisions and path traversal attacks
5. **Soft Delete for Avatars**: Keep old avatars for potential recovery

## Technical Context

| Category | Technology |
|----------|------------|
| Runtime | Node.js |
| Framework | Express.js |
| Language | TypeScript |
| Database | PostgreSQL |
| ORM | Prisma |
| File Upload | multer |
| Image Processing | sharp |
| Storage | Local FS / AWS S3 |
| Validation | zod |
| Testing | Jest, Supertest |

## Implementation Phases

### Phase 1: Database & Types
**Goal**: Extend database schema and define TypeScript types

**Tasks**:
- [ ] T-1.1: Extend User model with profile fields (displayName, bio, avatarUrl)
- [ ] T-1.2: Create TypeScript interfaces for profile DTOs
- [ ] T-1.3: Create zod validation schemas for profile updates

### Phase 2: Profile CRUD
**Goal**: Implement basic profile read/update operations

**Tasks**:
- [ ] T-2.1: Create profile.service.ts with getProfile and updateProfile
- [ ] T-2.2: Create profile.routes.ts with GET/PATCH /profile endpoints
- [ ] T-2.3: Add profile validators for input sanitization
- [ ] T-2.4: Write unit tests for profile service

### Phase 3: Avatar Upload Infrastructure
**Goal**: Set up file upload handling and storage

**Tasks**:
- [ ] T-3.1: Configure multer middleware for image uploads
- [ ] T-3.2: Create storage.service.ts with abstract storage interface
- [ ] T-3.3: Implement local filesystem storage adapter
- [ ] T-3.4: Implement image processing with sharp (resize to 200x200, 400x400)
- [ ] T-3.5: Add file validation (max 5MB, jpg/png/webp only)

### Phase 4: Avatar Endpoints
**Goal**: Implement avatar upload, update, and delete functionality

**Tasks**:
- [ ] T-4.1: POST /profile/avatar - Upload new avatar
- [ ] T-4.2: DELETE /profile/avatar - Remove current avatar
- [ ] T-4.3: Implement avatar URL generation (signed URLs for S3)
- [ ] T-4.4: Add cleanup job for orphaned avatar files

### Phase 5: Testing & Polish
**Goal**: Comprehensive testing and error handling

**Tasks**:
- [ ] T-5.1: Write integration tests for profile endpoints
- [ ] T-5.2: Write integration tests for avatar upload/delete
- [ ] T-5.3: Add error handling for storage failures
- [ ] T-5.4: Add rate limiting to upload endpoint

## File Changes

### New Files
- `src/services/profile.service.ts` - Profile business logic
- `src/services/storage.service.ts` - File storage abstraction
- `src/services/image.service.ts` - Image processing with sharp
- `src/routes/profile.routes.ts` - Profile API endpoints
- `src/validators/profile.validator.ts` - Profile input validation
- `src/middleware/upload.middleware.ts` - Multer configuration
- `src/types/profile.types.ts` - Profile-related TypeScript types
- `tests/integration/profile.test.ts` - Profile integration tests
- `uploads/avatars/` - Local avatar storage directory

### Modified Files
- `prisma/schema.prisma` - Add profile fields to User model
- `src/index.ts` - Register profile routes
- `src/types/index.ts` - Export profile types
- `.env` - Add storage configuration variables

## API Endpoints

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | /profile | Get current user's profile | Yes |
| PATCH | /profile | Update profile fields | Yes |
| POST | /profile/avatar | Upload avatar image | Yes |
| DELETE | /profile/avatar | Remove avatar image | Yes |

## Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| STORAGE_TYPE | Storage backend type | local / s3 |
| UPLOAD_DIR | Local upload directory | ./uploads |
| MAX_FILE_SIZE | Max upload size in bytes | 5242880 |
| AWS_S3_BUCKET | S3 bucket name (if using S3) | my-app-avatars |
| AWS_REGION | AWS region (if using S3) | us-east-1 |

## Dependencies

### New npm packages
- `multer` - Multipart form handling
- `@types/multer` - TypeScript types for multer
- `sharp` - Image processing
- `uuid` - Generate unique filenames
- `@aws-sdk/client-s3` - S3 client (optional, for S3 storage)

### Internal Dependencies
- Requires `test-auth` to be implemented first (auth middleware, User model)

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Large file uploads blocking server | High | Use streaming uploads, file size limits |
| Storage quota exhaustion | Medium | Implement cleanup jobs, monitoring |
| Image processing memory spikes | Medium | Process images in worker threads |
| Path traversal attacks | High | Use UUID filenames, validate paths |

## Database Schema Changes

```prisma
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  displayName   String?
  bio           String?
  avatarUrl     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  refreshTokens RefreshToken[]
}
```

## Notes

- Avatar URLs should be served through a CDN in production
- Consider implementing avatar caching headers
- S3 storage adapter can be added in Phase 3 as optional enhancement
- Profile updates should trigger cache invalidation if caching is implemented
